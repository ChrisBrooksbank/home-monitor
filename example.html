<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refactored Code Example</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .controls {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .log {
            background: #000;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        h2 {
            color: #4CAF50;
        }
    </style>
</head>
<body>
    <h1>üè† Refactored Home Automation Example</h1>
    <p>This demonstrates the new modular architecture with centralized config, logging, and error handling.</p>

    <div class="controls">
        <h2>Sonos Controls</h2>
        <button id="sonos-play">‚ñ∂Ô∏è Play</button>
        <button id="sonos-pause">‚è∏Ô∏è Pause</button>
        <button id="sonos-vol-up">üîä Volume +</button>
        <button id="sonos-vol-down">üîâ Volume -</button>
    </div>

    <div class="controls">
        <h2>Tapo Smart Plug</h2>
        <button id="tapo-on">üí° Turn ON</button>
        <button id="tapo-off">‚ö´ Turn OFF</button>
        <button id="tapo-status">‚ÑπÔ∏è Get Status</button>
    </div>

    <div class="controls">
        <h2>Console Output</h2>
        <div class="log" id="console-output">
            Console logs will appear here...
        </div>
    </div>

    <!-- Load modules in correct order -->
    <script src="js/config.js"></script>
    <script src="js/utils/logger.js"></script>
    <script src="js/utils/helpers.js"></script>
    <script src="js/api/sonos.js"></script>
    <script src="js/api/tapo.js"></script>

    <script>
        // Override console to display in page
        const consoleOutput = document.getElementById('console-output');
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function appendToConsole(type, args) {
            const message = Array.from(args).map(arg =>
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            consoleOutput.innerHTML += `<div style="color: ${
                type === 'error' ? '#ff6b6b' :
                type === 'warn' ? '#ffd93d' :
                type === 'success' ? '#6bcf7f' :
                '#fff'
            }">${message}</div>`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            appendToConsole('log', args);
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            appendToConsole('error', args);
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            appendToConsole('warn', args);
        };

        // Configuration for this example
        const SONOS_IP = '192.168.68.61'; // Bedroom speaker
        const TAPO_PLUG = 'tree'; // Tree lights plug

        // Enable debug logging
        APP_CONFIG.debug = true;

        // Initialize
        async function init() {
            Logger.info('Initializing home automation example...');

            // Check proxy availability
            const sonosAvailable = await SonosAPI.checkAvailability();
            const tapoAvailable = await TapoAPI.checkAvailability();

            // Disable controls if proxies not available
            if (!sonosAvailable) {
                document.querySelectorAll('#sonos-play, #sonos-pause, #sonos-vol-up, #sonos-vol-down')
                    .forEach(btn => btn.disabled = true);
                Logger.warn('Sonos controls disabled - start proxy with: node proxies/sonos-proxy.js');
            }

            if (!tapoAvailable) {
                document.querySelectorAll('#tapo-on, #tapo-off, #tapo-status')
                    .forEach(btn => btn.disabled = true);
                Logger.warn('Tapo controls disabled - start proxy with: node proxies/tapo-proxy.js');
            }

            Logger.success('Initialization complete!');
        }

        // Sonos Controls
        document.getElementById('sonos-play').addEventListener('click', async () => {
            try {
                await SonosAPI.play(SONOS_IP);
                Logger.success('Music playing!');
            } catch (error) {
                Logger.error('Failed to play:', error.message);
            }
        });

        document.getElementById('sonos-pause').addEventListener('click', async () => {
            try {
                await SonosAPI.pause(SONOS_IP);
                Logger.success('Music paused');
            } catch (error) {
                Logger.error('Failed to pause:', error.message);
            }
        });

        document.getElementById('sonos-vol-up').addEventListener('click', async () => {
            try {
                await SonosAPI.changeVolume(SONOS_IP, 5);
                const volume = await SonosAPI.getVolume(SONOS_IP);
                Logger.success(`Volume: ${volume}%`);
            } catch (error) {
                Logger.error('Failed to change volume:', error.message);
            }
        });

        document.getElementById('sonos-vol-down').addEventListener('click', async () => {
            try {
                await SonosAPI.changeVolume(SONOS_IP, -5);
                const volume = await SonosAPI.getVolume(SONOS_IP);
                Logger.success(`Volume: ${volume}%`);
            } catch (error) {
                Logger.error('Failed to change volume:', error.message);
            }
        });

        // Tapo Controls
        document.getElementById('tapo-on').addEventListener('click', async () => {
            try {
                await TapoAPI.turnOn(TAPO_PLUG);
            } catch (error) {
                Logger.error('Failed to turn on:', error.message);
            }
        });

        document.getElementById('tapo-off').addEventListener('click', async () => {
            try {
                await TapoAPI.turnOff(TAPO_PLUG);
            } catch (error) {
                Logger.error('Failed to turn off:', error.message);
            }
        });

        document.getElementById('tapo-status').addEventListener('click', async () => {
            try {
                const status = await TapoAPI.getStatus(TAPO_PLUG);
                Logger.info(`Plug status: ${JSON.stringify(status, null, 2)}`);
            } catch (error) {
                Logger.error('Failed to get status:', error.message);
            }
        });

        // Start the app
        init();
    </script>
</body>
</html>
